global
    daemon
    maxconn 4096
    log stdout format raw local0 info
    # Mejora: Estadísticas habilitadas para monitoreo
    stats socket /var/lib/haproxy/stats mode 666 level admin
    stats timeout 2m

defaults
    mode http
    # Mejora: Timeouts optimizados
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    timeout tarpit 60s
    log global
    # Mejora: Opciones de balanceo mejoradas
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    option redispatch
    retries 3
    # Mejora: Balanceo mejorado
    balance roundrobin

# Frontend HTTP - Mejorado con rate limiting y health checks avanzados
frontend http_front
    bind *:80
    # Mejora: Rate limiting para protección DDoS (100 conexiones por IP cada 10 segundos)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 100 }
    # Mejora: Estadísticas mejoradas
    stats enable
    stats uri /haproxy?stats
    stats refresh 30s
    stats admin if TRUE
    # Mejora: Logging mejorado
    capture request header Host len 64
    capture request header User-Agent len 128
    # Mejora: Redirección basada en path (routing mejorado)
    acl is_openwebui path_beg /api /chat /models
    acl is_n8n path_beg /webhook /rest /api/v1
    acl is_grafana path_beg /api /public /d
    acl is_prometheus path_beg /api/v1 /graph /alerts
    # Routing mejorado (mantiene funcionalidad existente)
    use_backend openwebui_back if is_openwebui
    use_backend n8n_back if is_n8n
    use_backend grafana_back if is_grafana
    use_backend prometheus_back if is_prometheus
    # Default backend (mantiene funcionalidad existente)
    default_backend http_back

# Backend principal (mantiene funcionalidad existente)
backend http_back
    balance roundrobin
    # Mejora: Health checks avanzados (sin httpchk global para compatibilidad)
    # Cada servidor tiene su propio health check
    server open-webui open-webui:8080 check inter 3s fall 3 rise 2
    server n8n n8n:5678 check inter 3s fall 3 rise 2
    server grafana grafana:3000 check inter 3s fall 3 rise 2
    server prometheus prometheus:9090 check inter 3s fall 3 rise 2

# Backend específico para Open WebUI (mejora de routing)
backend openwebui_back
    balance roundrobin
    option httpchk GET /healthz
    http-check expect status 200
    server open-webui open-webui:8080 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para n8n (mejora de routing)
backend n8n_back
    balance roundrobin
    option httpchk GET /healthz
    http-check expect status 200
    server n8n n8n:5678 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para Grafana (mejora de routing)
backend grafana_back
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    server grafana grafana:3000 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para Prometheus (mejora de routing)
backend prometheus_back
    balance roundrobin
    option httpchk GET /-/healthy
    http-check expect status 200
    server prometheus prometheus:9090 check inter 3s fall 3 rise 2

# HTTPS frontend (comentado hasta que se configuren certificados SSL)
# frontend https_front
#     bind *:443 ssl crt /etc/ssl/certs/server.pem
#     # Mejora: Rate limiting también en HTTPS
#     stick-table type ip size 100k expire 30s store http_req_rate(10s)
#     http-request track-sc0 src
#     http-request reject if { sc_http_req_rate(0) gt 100 }
#     stats enable
#     stats uri /haproxy?stats
#     stats refresh 30s
#     default_backend https_back
#
# backend https_back
#     balance roundrobin
#     option httpchk GET /healthz
#     http-check expect status 200
#     server open-webui open-webui:8080 check inter 3s fall 3 rise 2 ssl verify none
#     server n8n n8n:5678 check inter 3s fall 3 rise 2 ssl verify none
