global
    daemon
    maxconn 4096
    log stdout format raw local0 info
    # Mejora: Estadísticas habilitadas para monitoreo
    stats socket /var/lib/haproxy/stats mode 666 level admin
    stats timeout 2m

# Resolución DNS dinámica para Docker
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout retry 1s
    hold valid 10s

defaults
    mode http
    # Mejora: Timeouts optimizados
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    timeout tarpit 60s
    log global
    # Mejora: Opciones de balanceo mejoradas
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    option redispatch
    retries 3
    # Mejora: Balanceo mejorado
    balance roundrobin
    # Mejora: DNS Lazy Resolution para evitar crash al inicio si los backends no están listos
    default-server init-addr last,libc,none

# Frontend HTTP - Mejorado con rate limiting y health checks avanzados
frontend http_front
    bind *:80
    # Mejora: Rate limiting para protección DDoS (100 conexiones por IP cada 10 segundos)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 100 }
    # Mejora: Estadísticas mejoradas
    stats enable
    stats uri /haproxy?stats
    stats refresh 30s
    stats admin if TRUE
    # Mejora: Prometheus Exporter nativo en /metrics
    http-request use-service prometheus-exporter if { path /metrics }
    # Mejora: Logging mejorado
    capture request header Host len 64
    capture request header User-Agent len 128
    # Mejora: Redirección basada en path (routing mejorado)
    acl is_openwebui path_beg /api /chat /models
    acl is_n8n path_beg /webhook /rest /api/v1
    acl is_grafana path_beg /grafana
    acl is_prometheus path_beg /prometheus
    acl is_alertmanager path_beg /alertmanager
    acl is_ollama path_beg /ollama
    # Routing mejorado (mantiene funcionalidad existente)
    use_backend openwebui_back if is_openwebui
    use_backend n8n_back if is_n8n
    use_backend grafana_back if is_grafana
    use_backend grafana_back if is_grafana
    use_backend prometheus_back if is_prometheus
    use_backend alertmanager_back if is_alertmanager
    use_backend ollama_back if is_ollama
    # Default backend (mantiene funcionalidad existente)
    default_backend http_back

# Backend principal (mantiene funcionalidad existente)
backend http_back
    balance roundrobin
    # Mejora: Health checks avanzados (sin httpchk global para compatibilidad)
    # Cada servidor tiene su propio health check
    server open-webui open-webui:8080 check inter 3s fall 3 rise 2

# Backend Ollama con Cola de Peticiones (Protección de GPU)
backend ollama_back
    balance roundrobin
    # Reescribir path: /ollama/api/tags -> /api/tags
    http-request replace-path /ollama(/)?(.*) /\2
    # maxconn 1 = Solo 1 petición a la vez en la GPU. El resto espera.
    # timeout queue 60s = Si espera más de 60s, error 503.
    timeout queue 60s
    server ollama ollama:11434 check maxconn 1 check inter 5s

# Backend específico para Open WebUI (mejora de routing)
backend openwebui_back
    balance roundrobin
    option httpchk GET /healthz
    http-check expect status 200
    server open-webui open-webui:8080 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para n8n (mejora de routing)
backend n8n_back
    balance roundrobin
    option httpchk GET /healthz
    http-check expect status 200
    server n8n n8n:5678 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para Grafana (mejora de routing)
backend grafana_back
    balance roundrobin
    option httpchk GET /grafana/api/health
    http-check expect rstatus (2|3)[0-9][0-9]
    server grafana grafana:3000 check inter 3s fall 3 rise 2
    # Mejora: Sticky sessions (opcional, comentado por defecto)
    # cookie SERVERID insert indirect nocache

# Backend específico para Prometheus (mejora de routing)
backend prometheus_back
    balance roundrobin
    option httpchk GET /prometheus/-/healthy
    http-check expect status 200
    server prometheus prometheus:9090 check inter 3s fall 3 rise 2

# Backend específico para AlertManager
backend alertmanager_back
    balance roundrobin
    option httpchk GET /alertmanager/-/healthy
    http-check expect rstatus (2|3)[0-9][0-9]
    # Server definition for AlertManager with dynamic resolution
    server alertmanager alertmanager:9093 check resolvers docker init-addr last,libc,none inter 5s fall 3 rise 2

# HTTPS frontend (comentado hasta que se configuren certificados SSL)
# frontend https_front
#     bind *:443 ssl crt /etc/ssl/certs/server.pem
#     # Mejora: Rate limiting también en HTTPS
#     stick-table type ip size 100k expire 30s store http_req_rate(10s)
#     http-request track-sc0 src
#     http-request reject if { sc_http_req_rate(0) gt 100 }
#     stats enable
#     stats uri /haproxy?stats
#     stats refresh 30s
#     default_backend https_back
#
# backend https_back
#     balance roundrobin
#     option httpchk GET /healthz
#     http-check expect status 200
#     server open-webui open-webui:8080 check inter 3s fall 3 rise 2 ssl verify none
#     server n8n n8n:5678 check inter 3s fall 3 rise 2 ssl verify none
