%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#1a1a2e', 'primaryTextColor':'#eaeaea', 'primaryBorderColor':'#4a4a6a', 'lineColor':'#6c63ff', 'fontSize':'13px', 'fontFamily':'Inter, Segoe UI, sans-serif'}}}%%
graph TB
    subgraph FRONTEND ["ğŸŒ Frontend Layer"]
        USER(["ğŸ‘¤ User<br/>Browser"])
        HAPROXY["ğŸ”€ HAProxy<br/>Load Balancer<br/>:80 / :443"]
    end
    
    subgraph SECURITY ["ğŸ” Security Layer"]
        KC["ğŸ” Keycloak<br/>SSO Provider<br/>:8080"]
        MODSEC["ğŸ›¡ï¸ ModSecurity<br/>WAF"]
        KCINIT["âš™ï¸ keycloak-init<br/>Auto-config"]
    end
    
    subgraph AI ["ğŸ¤– AI Services"]
        OLLAMA["ğŸ§  Ollama<br/>LLM Engine<br/>:11434"]
        WEBUI["ğŸ’¬ Open WebUI<br/>Chat Interface<br/>:3000"]
    end
    
    subgraph AUTOMATION ["âš™ï¸ Automation"]
        N8N["âš™ï¸ n8n<br/>Workflows<br/>:5678"]
        JENKINS["ğŸ”§ Jenkins<br/>CI/CD<br/>:8081â†’8082"]
        WATCH["ğŸ”„ Watchtower<br/>Auto-updates"]
        SYNC["ğŸ“‚ Sync<br/>Data sync"]
    end
    
    subgraph MONITORING ["ğŸ“Š Monitoring Stack"]
        PROM["ğŸ“Š Prometheus<br/>Metrics<br/>:9090"]
        GRAF["ğŸ“ˆ Grafana<br/>Dashboards<br/>:3001"]
        ALERT["ğŸ”” AlertManager<br/>Alerts<br/>:9093"]
        BACKUP["ğŸ’¾ Backup Runner<br/>Daily backups"]
    end
    
    subgraph EXPORTERS ["ğŸ“¡ Metrics Exporters"]
        direction LR
        NVEXP["nvidia<br/>:9400"]
        OLLEXP["ollama<br/>:9888"]
        N8NEXP["n8n<br/>:9889"]
        OWEXP["webui<br/>:9890"]
        REDEXP["redis<br/>:9121"]
        PGEXP["postgres<br/>:9187"]
        NODEEXP["node<br/>:9100"]
        CADV["cAdvisor<br/>:8082"]
    end
    
    subgraph DATA ["ğŸ—„ï¸ Data Layer"]
        PG["ğŸ—„ï¸ PostgreSQL<br/>Main DB<br/>:5432"]
        REDIS["ğŸ’¾ Redis<br/>Cache<br/>:6379"]
        QDRANT["ğŸ”® Qdrant<br/>Vectors<br/>:6333"]
        PGVEC["ğŸ“ pgvector<br/>:5433"]
    end
    
    %% User Flow
    USER -->|"HTTP/S"| HAPROXY
    HAPROXY -->|"/chat"| WEBUI
    HAPROXY -->|"/grafana"| GRAF
    HAPROXY -->|"/prometheus"| PROM
    HAPROXY -->|"/alertmanager"| ALERT
    HAPROXY --> MODSEC
    
    %% AI Flow
    WEBUI -->|"Inference"| OLLAMA
    WEBUI -->|"OIDC"| KC
    WEBUI -->|"Cache"| REDIS
    WEBUI -->|"Data"| PG
    WEBUI -->|"Embeddings"| QDRANT
    
    %% Automation Flow
    N8N -->|"AI Calls"| OLLAMA
    N8N -->|"OIDC"| KC
    N8N -->|"Data"| PG
    JENKINS -->|"OIDC"| KC
    
    %% Monitoring Flow
    GRAF -->|"Query"| PROM
    GRAF -->|"OIDC"| KC
    PROM -->|"Alerts"| ALERT
    
    %% Exporters to Prometheus
    NVEXP -.-> PROM
    OLLEXP -.-> PROM
    N8NEXP -.-> PROM
    OWEXP -.-> PROM
    REDEXP -.-> PROM
    PGEXP -.-> PROM
    NODEEXP -.-> PROM
    CADV -.-> PROM
    
    %% Security init
    KCINIT -->|"Configure"| KC
    
    %% Styling
    classDef frontend fill:#0d47a1,stroke:#1976d2,stroke-width:2px,color:#fff
    classDef security fill:#b71c1c,stroke:#d32f2f,stroke-width:2px,color:#fff
    classDef ai fill:#1565c0,stroke:#1e88e5,stroke-width:2px,color:#fff
    classDef automation fill:#4a148c,stroke:#7b1fa2,stroke-width:2px,color:#fff
    classDef monitoring fill:#1b5e20,stroke:#388e3c,stroke-width:2px,color:#fff
    classDef exporters fill:#e65100,stroke:#f57c00,stroke-width:2px,color:#fff
    classDef data fill:#37474f,stroke:#607d8b,stroke-width:2px,color:#fff
    
    class USER,HAPROXY frontend
    class KC,MODSEC,KCINIT security
    class OLLAMA,WEBUI ai
    class N8N,JENKINS,WATCH,SYNC automation
    class PROM,GRAF,ALERT,BACKUP monitoring
    class NVEXP,OLLEXP,N8NEXP,OWEXP,REDEXP,PGEXP,NODEEXP,CADV exporters
    class PG,REDIS,QDRANT,PGVEC data
