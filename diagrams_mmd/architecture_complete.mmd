%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e3f2fd', 'primaryTextColor':'#1a237e', 'primaryBorderColor':'#1976d2', 'lineColor':'#424242', 'secondaryColor':'#f3e5f5', 'tertiaryColor':'#e8f5e9', 'fontSize':'16px'}}}%%
graph TB
    subgraph "Frontend Layer"
        User(["ğŸ‘¤ User"])
        HAProxy["ğŸŒ HAProxy<br/>Load Balancer<br/>Port 80"]
    end
    
    subgraph "AI Services"
        Ollama["ğŸ¤– Ollama<br/>LLM Engine<br/>GPU-Accelerated"]
        OpenWebUI["ğŸ’¬ Open WebUI<br/>Chat Interface<br/>Port 3000"]
    end
    
    subgraph "Automation & Workflow"
        N8N["âš™ï¸ n8n<br/>Workflow Automation<br/>Port 5678"]
    end
    
    subgraph "Security & Auth"
        Keycloak["ğŸ” Keycloak<br/>SSO / OIDC Provider<br/>Port 8080"]
        ModSecurity["ğŸ›¡ï¸ ModSecurity<br/>Web Application Firewall"]
    end
    
    subgraph "Infrastructure"
        Redis["ğŸ’¾ Redis<br/>Cache & Sessions<br/>Port 6379"]
        PostgreSQL["ğŸ—„ï¸ PostgreSQL<br/>Primary Database<br/>Port 5432"]
    end
    
    subgraph "Monitoring Stack"
        Prometheus["ğŸ“Š Prometheus<br/>Metrics Storage<br/>Port 9090"]
        Grafana["ğŸ“ˆ Grafana<br/>Dashboards<br/>Port 4000"]
        AlertManager["ğŸ”” AlertManager<br/>Alerts<br/>Port 9093"]
    end
    
    subgraph "Exporters"
        NvidiaExp["ğŸ“¡ nvidia-exporter"]
        OllamaExp["ğŸ“¡ ollama-exporter"]
        N8NExp["ğŸ“¡ n8n-exporter"]
        OpenWebUIExp["ğŸ“¡ openwebui-exporter"]
        RedisExp["ğŸ“¡ redis-exporter"]
        PostgresExp["ğŸ“¡ postgres-exporter"]
    end
    
    %% User Flow
    User -->|HTTP/HTTPS| HAProxy
    HAProxy -->|Route /| OpenWebUI
    HAProxy -->|Route /n8n| N8N
    HAProxy -->|Route /grafana| Grafana
    HAProxy -->|Route /auth| Keycloak
    HAProxy -->|Route /prometheus| Prometheus
    
    %% AI Services
    OpenWebUI -->|Generate| Ollama
    OpenWebUI -->|OIDC Auth| Keycloak
    OpenWebUI -->|Cache Sessions| Redis
    OpenWebUI -->|Store Data| PostgreSQL
    
    %% Automation
    N8N -->|Call Models| Ollama
    N8N -->|OIDC Auth| Keycloak
    N8N -->|Store Workflows| PostgreSQL
    
    %% Monitoring
    Grafana -->|Query Metrics| Prometheus
    Grafana -->|OIDC Auth| Keycloak
    Prometheus -->|Send Alerts| AlertManager
    
    %% Exporters to Prometheus
    NvidiaExp -.->|GPU Metrics| Prometheus
    OllamaExp -.->|Model Metrics| Prometheus
    N8NExp -.->|Workflow Metrics| Prometheus
    OpenWebUIExp -.->|Chat Metrics| Prometheus
    RedisExp -.->|Cache Metrics| Prometheus
    PostgresExp -.->|DB Metrics| Prometheus
    
    %% Services to Exporters
    Ollama -.-> NvidiaExp
    Ollama -.-> OllamaExp
    N8N -.-> N8NExp
    OpenWebUI -.-> OpenWebUIExp
    Redis -.-> RedisExp
    PostgreSQL -.-> PostgresExp
    
    %% Security
    HAProxy --> ModSecurity
    
    %% Styling
    classDef ai fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1a237e
    classDef security fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#b71c1c
    classDef infra fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#4a148c
    classDef monitoring fill:#e8f5e9,stroke:#388e3c,stroke-width:3px,color:#1b5e20
    classDef exporters fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
    classDef frontend fill:#e0f2f1,stroke:#00796b,stroke-width:3px,color:#004d40
    
    class Ollama,OpenWebUI ai
    class Keycloak,ModSecurity security
    class Redis,PostgreSQL infra
    class Prometheus,Grafana,AlertManager monitoring
    class NvidiaExp,OllamaExp,N8NExp,OpenWebUIExp,RedisExp,PostgresExp exporters
    class User,HAProxy frontend
    class N8N ai
