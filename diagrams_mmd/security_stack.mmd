%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#1a1a2e', 'primaryTextColor':'#eaeaea', 'primaryBorderColor':'#4a4a6a', 'lineColor':'#6c63ff', 'fontSize':'14px', 'fontFamily':'Inter, Segoe UI, sans-serif'}}}%%
graph TB
    subgraph TITLE ["ğŸ” SECURITY STACK - Authentication & Protection"]
        direction LR
        CMD["./stack-manager.sh start security"]
    end
    
    subgraph SECURITY ["ğŸ” security profile"]
        KC["ğŸ” Keycloak<br/>SSO / OIDC Provider<br/>:8080<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ User Management<br/>â€¢ Realm: ai-kit<br/>â€¢ Metrics: :9000"]
        
        MODSEC["ğŸ›¡ï¸ ModSecurity<br/>Web Application Firewall<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ OWASP CRS Rules<br/>â€¢ Request Filtering<br/>â€¢ Attack Prevention"]
        
        KCINIT["âš™ï¸ keycloak-init<br/>Auto Configuration<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Create Clients<br/>â€¢ Setup OIDC<br/>â€¢ Update .env"]
    end
    
    subgraph CLIENTS ["ğŸ”— OIDC Clients (Auto-configured)"]
        direction LR
        C1["ğŸ’¬ open-webui"]
        C2["ğŸ“ˆ grafana"]
        C3["âš™ï¸ n8n"]
        C4["ğŸ”§ jenkins"]
    end
    
    subgraph PROTECTED ["ğŸ›¡ï¸ Protected Services"]
        WEBUI["ğŸ’¬ Open WebUI"]
        GRAF["ğŸ“ˆ Grafana"]
        N8N["âš™ï¸ n8n"]
        JENKINS["ğŸ”§ Jenkins"]
    end
    
    subgraph DATA ["ğŸ—„ï¸ Backend"]
        PG["ğŸ—„ï¸ PostgreSQL<br/>Keycloak DB"]
    end
    
    %% Connections
    KCINIT -->|"Configure"| KC
    KC -->|"Store"| PG
    
    KC -->|"SSO"| C1
    KC -->|"SSO"| C2
    KC -->|"SSO"| C3
    KC -->|"SSO"| C4
    
    C1 --> WEBUI
    C2 --> GRAF
    C3 --> N8N
    C4 --> JENKINS
    
    MODSEC -->|"Protects"| KC
    MODSEC -->|"Protects"| WEBUI
    
    %% Styling
    classDef title fill:#1a1a2e,stroke:#6c63ff,stroke-width:0px,color:#fff
    classDef security fill:#b71c1c,stroke:#d32f2f,stroke-width:2px,color:#fff
    classDef clients fill:#ff6f00,stroke:#ff8f00,stroke-width:2px,color:#fff
    classDef protected fill:#1565c0,stroke:#1e88e5,stroke-width:2px,color:#fff
    classDef data fill:#37474f,stroke:#607d8b,stroke-width:2px,color:#fff
    
    class CMD title
    class KC,MODSEC,KCINIT security
    class C1,C2,C3,C4 clients
    class WEBUI,GRAF,N8N,JENKINS protected
    class PG data
