%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#fff3e0', 'primaryTextColor':'#e65100', 'primaryBorderColor':'#f57c00', 'lineColor':'#424242', 'fontSize':'16px'}}}%%
sequenceDiagram
    autonumber
    
    participant User as ğŸ‘¤ User<br/>Browser
    participant Client as ï¿½ï¸ OIDC Client<br/>(WebUI, Grafana, Jenkins)
    participant FakeDisc as ğŸ“„ oidc-config.json<br/>(Split DNS Fix)
    participant Keycloak as ğŸ” Keycloak<br/>(Auth Server)
    participant Data as ğŸ—„ï¸ Backend DB<br/>(User Mapping)
    
    rect rgb(255, 243, 224)
    Note over User,Data: Phase 1: Discovery (Split-Horizon Solution)
    User->>Client: 1. Click "Sign in with Keycloak"
    Client->>FakeDisc: 2. GET /static/oidc-config.json
    FakeDisc-->>Client: 3. Return internal/external URLs
    end
    
    rect rgb(232, 245, 233)
    Note over User,Data: Phase 2: Authorization (Browser Flow)
    Client->>User: 4. Redirect to auth page
    User->>Keycloak: 5. Login at localhost:8080
    Keycloak-->>User: 6. Redirect with Auth Code
    end
    
    rect rgb(227, 242, 253)
    Note over User,Data: Phase 3: Token Exchange (Backend Flow)
    User->>Client: 7. Callback with code
    Client->>Keycloak: 8. POST keycloak:8080/token
    Keycloak-->>Client: 9. Return Access/ID Tokens
    end
    
    rect rgb(243, 229, 245)
    Note over User,Data: Phase 4: Automated Setup (Jenkins/Admin)
    Client->>Data: 10. Auto-provision user
    Data-->>Client: 11. Profile linked
    Client-->>User: 12. âœ… Login successful
    end
    
    Note over User,Data: ğŸ¯ Result: Unified SSO Suite Complete
