%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#1a1a2e', 'primaryTextColor':'#eaeaea', 'primaryBorderColor':'#4a4a6a', 'lineColor':'#6c63ff', 'fontSize':'13px', 'fontFamily':'Inter, Segoe UI, sans-serif', 'actorTextColor':'#fff', 'actorBkg':'#0d47a1', 'signalColor':'#6c63ff', 'signalTextColor':'#1a1a2e'}}}%%
sequenceDiagram
    autonumber
    
    participant User as ğŸ‘¤ User Browser
    participant Client as ğŸ–¥ï¸ OIDC Client<br/>(WebUI/Grafana/Jenkins)
    participant Static as ğŸ“„ oidc-config.json<br/>(Split-Horizon DNS)
    participant Keycloak as ğŸ” Keycloak<br/>:8080
    participant DB as ğŸ—„ï¸ PostgreSQL
    
    rect rgb(13, 71, 161)
    Note over User,DB: ğŸ” Phase 1: Discovery (Split-Horizon Solution)
    User->>Client: Click "Sign in with Keycloak"
    Client->>Static: GET /static/oidc-config.json
    Note right of Static: Returns:<br/>â€¢ Browser URL: localhost:8080<br/>â€¢ Backend URL: keycloak:8080
    Static-->>Client: OIDC Configuration
    end
    
    rect rgb(27, 94, 32)
    Note over User,DB: ğŸ”‘ Phase 2: Authorization (Browser Flow)
    Client->>User: Redirect to Keycloak login
    User->>Keycloak: Enter credentials at localhost:8080
    Keycloak->>DB: Validate user
    DB-->>Keycloak: User valid
    Keycloak-->>User: Redirect with authorization code
    end
    
    rect rgb(74, 20, 140)
    Note over User,DB: ğŸ« Phase 3: Token Exchange (Backend Flow)
    User->>Client: Callback with auth code
    Client->>Keycloak: POST keycloak:8080/token
    Note right of Client: Uses internal hostname<br/>(Docker network)
    Keycloak-->>Client: Access Token + ID Token + Refresh Token
    end
    
    rect rgb(230, 81, 0)
    Note over User,DB: âœ… Phase 4: Session Established
    Client->>DB: Create/Update user profile
    DB-->>Client: Profile ready
    Client-->>User: âœ… Login successful!
    end
    
    Note over User,DB: ğŸ¯ Result: SSO across Open WebUI, Grafana, n8n, Jenkins
