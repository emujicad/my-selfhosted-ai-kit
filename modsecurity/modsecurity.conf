# =============================================================================
# ModSecurity Configuration
# =============================================================================
# Configuración principal de ModSecurity para el stack de IA
# =============================================================================

# Modo de operación: Detection (detección) o Prevention (bloqueo)
# En desarrollo: Detection
# En producción: Prevention (después de probar)
SecRuleEngine DetectionOnly

# Nivel de paranoia (1-4)
# 1 = Menos estricto, menos falsos positivos
# 4 = Muy estricto, más protección pero más falsos positivos
SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=1"

# Límite de tamaño del cuerpo de la petición (en bytes)
# Ajusta según tus necesidades
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Tamaño máximo de archivo subido (en bytes)
SecRequestBodyLimitAction Reject

# Directorio temporal para procesamiento
SecTmpDir /tmp/

# Directorio de datos persistentes
SecDataDir /tmp/

# Configuración de logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/modsec_audit.log

# Configuración de reglas
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# Deshabilitar reglas problemáticas comunes (ajusta según necesidad)
# SecRuleRemoveById 949110  # Ejemplo: remover regla específica si causa problemas

# Configuración de encoding
SecContentInjection On
SecStreamOutBodyInspection On

# Timeout para procesamiento
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml

# Límite de profundidad de XML
SecXmlExternalEntity On

